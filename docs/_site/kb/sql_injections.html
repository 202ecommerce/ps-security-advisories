<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>202 ecommerce Security Advisories | Knowledge Base and CVE about PrestaShop modules security issues</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="202 ecommerce Security Advisories" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Knowledge Base and CVE about PrestaShop modules security issues" />
<meta property="og:description" content="Knowledge Base and CVE about PrestaShop modules security issues" />
<link rel="canonical" href="http://localhost:4000/kb/sql_injections.html" />
<meta property="og:url" content="http://localhost:4000/kb/sql_injections.html" />
<meta property="og:site_name" content="202 ecommerce Security Advisories" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="202 ecommerce Security Advisories" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Knowledge Base and CVE about PrestaShop modules security issues","headline":"202 ecommerce Security Advisories","url":"http://localhost:4000/kb/sql_injections.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style" type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=4bc3c89cac8fbad3ba971bc19bb35e9f7b5409b1">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <a id="skip-to-content" href="#content">Skip to the content.</a>

    <header class="page-header" role="banner">
      
      <h1 class="project-name">
      
        <a href="/security-advisories/index.html" style="color:#e9edee">
          <!-- <img src="" style="width:0%; height:0%"> -->
          202 ecommerce Security Advisories
        </a>
      </h1>

      <h2 class="project-tagline">
        Knowledge Base and CVE about PrestaShop modules security issues
      </h2>

      
        <a href="index.html" class="btn">Index</a>
      

      
        <a href="https://github.com/cbourgeois202/security-advisories" class="btn">View on GitHub</a>
      

      

      
        
          <a href="../index.html" class="btn">Home page</a>
        
      

    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="prevent-sql-injections">Prevent SQL injections</h1>

<p>Sensitive SQL calls can turn into sql injection, that’s why it’s very important to know all risks and matters to prevent sql injections. This note is important if you use legacy classes of PrestaShop.</p>

<p>Don’t forget at any time that the validation of any request parameter (GET, POST, body content, sub json variable,…) is very required.</p>

<ol>
  <li><a href="#basic-sample">Basic sample</a></li>
  <li><a href="#array-values-sample">Array values sample</a></li>
  <li><a href="#table-name-or-field-name-protection">Table name or field name protection</a></li>
  <li><a href="#orderby-and-orderway-protection">OrderBy and orderWay protection</a></li>
  <li><a href="#other-cases-like-casethen-functions">Other cases like case/then, functions…</a></li>
  <li><a href="#prestashop-object-models-natively-protected-against-sql-injection">PrestaShop object models natively protected against SQL injection</a></li>
</ol>

<h2 id="basic-sample">Basic sample</h2>

<blockquote>
  <p><strong><em>DON’T DO:</em></strong></p>
  <pre><code class="language-PHP">function test(int $id, string $name) {
    $querystr = 'SELECT id, name FROM mytable WHERE id = $id AND name = "' . $name . '"';
    return Db::getInstance()-&gt;executeS($querystr);
}
</code></pre>
</blockquote>

<p>This request has a vulnerability named “sensitive sql call” because if :</p>

<blockquote>
  <pre><code class="language-PHP">$name = 'dummy" UNION SELECT id_configuration AS id, value AS name FROM ps_configuration;#';
</code></pre>
</blockquote>

<p>The previous method test() will return the list of PrestaShop configuration tables with this sql injection.</p>

<p>To fix this sensitive SQL call you need to use pSQL(<code class="language-plaintext highlighter-rouge">$name</code>) like this. In this case, characters “ will be backslash.</p>

<p>Please note: <strong>pSQL is not efficient without quotes</strong>, for integer variables. Some malicious injections can be forged without quote like :</p>

<blockquote>
  <pre><code class="language-PHP">$id = '1; DROP TABLE test;#'
(pSQL($id) == $id) === true
</code></pre>
</blockquote>

<p>The same method (variant using also <em>DbQuery</em> class) without the type hint of test method argument. Do not use pSQL to fix this sensitive SQL call, use an explicit casting like (int) (or float if need) :</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">function test($id, $name) {
   $query = new DbQuery();
   $query-&gt;select('id, name');
   $query-&gt;from('mytable');
   $query-&gt;where('id = ' . (int) $id . ' AND name = "' . pSQL($name) . '"');
   $results = Db::getInstance()-&gt;executeS($query);
}
</code></pre>
</blockquote>

<p>Other recommandations :</p>
<ul>
  <li>The cast (string), (array) or (object) don’t protect anything. Be careful with data from a JSON string that can have a sub argument not secured !</li>
  <li><strong>Do not “hide” your parameters in base64. WAF (Applicative firewall) are not efficient to detect SQL injections if it’s un base64 !</strong></li>
</ul>

<p>For quick reviewing or if you want to automate some regex to improve quality and security checks, it’s highly recommended to add your protection method as near as possible of the SQL call ! As far, not in a different file. No impact on performance in case of several (int) or pSQL().</p>

<h2 id="array-values-sample">Array values sample</h2>

<p>To protect IN where clause with an array of values, use array map to cast or pSQL to protect each element of the array.</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">$ids = [1,2,3];
$name = ['kiwi', 'apple'];

function test(array $ids, array $name) {
   $querystr = 'SELECT id, name FROM mytable WHERE id IN ( ' . implode(',', array_map('intval', $ids )) . ' AND name IN ("' . implode ('","', array_map('pSQL', $name )) '")';
   return $querystr;
}
</code></pre>
</blockquote>

<h2 id="table-name-or-field-name-protection">Table name or field name protection</h2>

<p>This is another sensitive SQL call :</p>

<blockquote>
  <p><strong><em>DON’T DO:</em></strong></p>
  <pre><code class="language-PHP">function test($id, $name) {
   $querystr = 'SELECT id, ' . $name . ' FROM mytable WHERE id = ' . (int) $id;
   return Db::getInstance()-&gt;executeS($querystr);
}
</code></pre>
</blockquote>

<p>Use <code class="language-plaintext highlighter-rouge">'bqSQL($name)'</code> will escape backtick characters.</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">function test($id, $name) {
   $querystr = 'SELECT id, `' . bqSQL($name) . '` FROM mytable WHERE id = ' . (int) $id;
   return Db::getInstance()-&gt;executeS($querystr);
}
</code></pre>
</blockquote>

<p>You should always use bqSQL() between two backticks to be efficient !</p>

<p>Do <strong>not</strong> use pSQL() instead of bqSQL().</p>

<h2 id="orderby-and-orderway-protection">OrderBy and orderWay protection</h2>

<p>Only class <em>Validate</em> with method <em>isOrderWay() isOrderBy()</em> before using the parameter is a good solution to prevent SQL injection ! All other solution can introduce SQL error in case of</p>

<blockquote>
  <p><strong><em>DON’T DO:</em></strong></p>
  <pre><code class="language-PHP">function test($orderWay, $orderBy) {
   $querystr = 'SELECT id, name FROM mytable ORDER BY `' . bqSQL($orderBy) . '` ' . pSQL($orderWay);
   return Db::getInstance()-&gt;executeS($querystr);
}
</code></pre>
</blockquote>

<p>Instead of this previous sensitive SQL call :</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">function test($orderWay, $orderBy) {
   if (Validate::isOrderWay($orderWay) === false){
       $orderWay = 'DESC';
   }
   if (Validate::isOrderBy($orderWay) === false) {
       $orderBy = 'name';
   }
   $querystr = 'SELECT id, name FROM mytable ORDER BY `' . bqSQL($orderBy) . '` ' . $orderWay;
   return Db::getInstance()-&gt;executeS($querystr);
}
</code></pre>
</blockquote>

<p>Do not use pSQL() or bqSQL() in an order direction.</p>

<h2 id="other-cases-like-casethen-functions">Other cases like case/then, functions…</h2>

<p>I hope you understand it will be impossible to easily protect parameters when it’s not an integer or a string between quotes or backtick. So, for this specific case you need to refactor your code to send and validate all parameters on your own.</p>

<h2 id="prestashop-object-models-natively-protected-against-sql-injection">PrestaShop object models natively protected against SQL injection</h2>

<p>PrestaShop object models are natively safe because they include definitions of each field and a validation before a save or an update.</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">class Reinsurance extends ObjectModel
{
   public $id;
   public $id_shop;
   public $text;

   public static $definition = [
  	 'table' =&gt; 'reinsurance',
  	 'primary' =&gt; 'id_reinsurance',
  	 'multilang' =&gt; true,
  	 'fields' =&gt; [
  	     'id_shop' =&gt; ['type' =&gt; self::TYPE_INT, 'validate' =&gt; 'isunsignedInt', 'required' =&gt; true],
  	     'text' =&gt; ['type' =&gt; self::TYPE_STRING, 'validate' =&gt; 'isGenericName', 'required' =&gt; true],
  	 ]
   ];
}

$reinsurrance = new Reinsurance();
$reinsurrance-&gt;id_shop = Tools::getValue('id_shop');
$reinsurrance-&gt;text = Tools::getValue('text');
try {
   $reinsurrance-&gt;save();
} catch (Exception $e) {
   // exit;
}
</code></pre>
</blockquote>

<p>pSQL and cast are apply according to the definition.</p>

<p>You can also use PrestaShopCollection based on object model definition.</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">$collection = new PrestaShopCollection(Reinsurance::class);
$collection-&gt;where('text', '=',Tools::getValue('text'));
$collection-&gt;sqlWhere('id_shop', '=', Tools::getValue('id_shop'));
$collection-&gt;orderBy('id_reinsurance');
$reinsurances = $collection-&gt;getResults();
</code></pre>
</blockquote>

<p><br /></p>

<hr />

<p><br /></p>

<table>
  <tbody>
    <tr>
      <td><a href="/security-advisories/kb/index.html"><img src="/kb/images/back-to-menu-arrow-9121722.png" alt="go back" /></a></td>
      <td><a href="#prevent-sql-injections"><img src="/kb/images/up-arrow-1767592-1502496.png" alt="go up" /></a></td>
      <td><a href="/kb/php_injections.html">Prevent PHP injections</a></td>
      <td><a href="/security-advisories/kb/php_injections.html"><img src="/kb/images/right-arrow.png" alt="go right" /></a></td>
    </tr>
  </tbody>
</table>



      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/cbourgeois202/security-advisories">security-advisories</a> is maintained by <a href="https://github.com/cbourgeois202">cbourgeois202</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>
  </body>
</html>
