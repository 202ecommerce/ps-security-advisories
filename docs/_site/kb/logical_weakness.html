<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>202 ecommerce Security Advisories | Knowledge Base and CVE about PrestaShop modules security issues</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="202 ecommerce Security Advisories" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Knowledge Base and CVE about PrestaShop modules security issues" />
<meta property="og:description" content="Knowledge Base and CVE about PrestaShop modules security issues" />
<link rel="canonical" href="http://localhost:4000/kb/logical_weakness.html" />
<meta property="og:url" content="http://localhost:4000/kb/logical_weakness.html" />
<meta property="og:site_name" content="202 ecommerce Security Advisories" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="202 ecommerce Security Advisories" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Knowledge Base and CVE about PrestaShop modules security issues","headline":"202 ecommerce Security Advisories","url":"http://localhost:4000/kb/logical_weakness.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style" type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=4bc3c89cac8fbad3ba971bc19bb35e9f7b5409b1">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <a id="skip-to-content" href="#content">Skip to the content.</a>

    <header class="page-header" role="banner">
      
      <h1 class="project-name">
      
        <a href="/security-advisories/index.html" style="color:#e9edee">
          <!-- <img src="" style="width:0%; height:0%"> -->
          202 ecommerce Security Advisories
        </a>
      </h1>

      <h2 class="project-tagline">
        Knowledge Base and CVE about PrestaShop modules security issues
      </h2>

      
        <a href="index.html" class="btn">Index</a>
      

      
        <a href="https://github.com/cbourgeois202/security-advisories" class="btn">View on GitHub</a>
      

      

      
        
          <a href="../index.html" class="btn">Home page</a>
        
      

    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="prevent-logical-weakness">Prevent logical weakness</h1>

<ol>
  <li><a href="#standalone-script-without-modulefrontcontroller">Standalone script without ModuleFrontController</a></li>
  <li><a href="#weakness-token-in-a-front-controller">Weakness token in a front controller</a></li>
  <li><a href="#callback-of-a-wildcard-method">Callback of a wildcard method</a></li>
  <li><a href="#wildcard-data-in-the-prestashop-secures-cookie">Wildcard data in the PrestaShop secures cookie</a></li>
</ol>

<h2 id="standalone-script-without-modulefrontcontroller">Standalone script without ModuleFrontController</h2>

<p>Since PrestaShop 1.6, you can create a class that extends ModuleFrontController. Before 1.6, you can found addons with files like this, but <a href="https://devdocs.prestashop-project.org/8/modules/creation/good-practices/">don’t do that</a> :</p>

<blockquote>
  <p><strong><em>DON’T DO</em></strong></p>
  <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// modules/mymodule/ajax.php</span>
<span class="k">include</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/../../config/config.inc.php'</span><span class="p">);</span>
<span class="k">include</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'/../../init.php'</span><span class="p">);</span>
<span class="nv">$mymodule</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">mymodule</span><span class="p">();</span>
</code></pre></div>  </div>
</blockquote>

<p>This kind of code calls legacy PrestaShop Dispatcher and bypass all PrestaShop module loading security checks. So this script remains available if the module is disabled or uninstalled !</p>

<p>Recommandations :</p>
<ul>
  <li>As a maintainer of a PrestaShop website, remove physically from the server all unused modules.</li>
  <li>As a developer,
    <ul>
      <li>if you cannot have another solution add explicitly a check that disabled this script if the module is disabled.</li>
      <li>Add a check of PrestaShop &lt; 1.6 and create an equivalent module frontend controller (see this <a href="https://devdocs.prestashop-project.org/8/modules/concepts/controllers/front-controllers/#creating-a-front-controller">doc</a>)</li>
    </ul>
  </li>
</ul>

<h2 id="weakness-token-in-a-front-controller">Weakness token in a front controller</h2>

<p>It’s sometimes useful to protect a front controller with a static token for instance to protect a cron, a webhook, …</p>

<p><em>1) Check if ‘PS_TOKEN_ENABLE’ is enabled will deactivate the protection. This feature is not done to protect a controller.</em></p>

<blockquote>
  <p><strong><em>DON’T DO:</em></strong></p>
  <pre><code class="language-PHP">if (Configuration::get('PS_TOKEN_ENABLE') == 1 &amp;&amp;
       (Tools::getValue('token') != Tools::encrypt('mymodule'))) {
   echo 'Invalid token!';
   die();
}
</code></pre>
</blockquote>

<p>Use instead:</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">if (Tools::getValue('token') != Tools::encrypt('mymodule')) {
   echo 'Invalid token!';
   die();
}
</code></pre>
</blockquote>

<p><em>2) Tools::getToken() is assigned as a JavaScript variable on all pages. If you use this method, the token is predictable and not safe.</em></p>

<blockquote>
  <p><strong><em>DON’T DO:</em></strong></p>
  <pre><code class="language-PHP">if (Tools::getValue('token') != Tools::getToken()) {
   echo 'Invalid token!';
   die();
}
</code></pre>
</blockquote>

<p>Use instead:</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">if (Tools::getValue('token') != Tools::encrypt('mymodule')) {
   echo 'Invalid token!';
   die();
}
</code></pre>
</blockquote>

<p><em>3) Compare the token submitted with a predictable parameter. Add a secret like the COOKIE_KEY as salt !</em></p>

<blockquote>
  <p><strong><em>DON’T DO:</em></strong></p>
  <pre><code class="language-PHP">if (Tools::getValue('token') != sha1($this-&gt;module-&gt;name.'-'.$this-&gt;module-&gt;version)) {
   echo 'Invalid token!';
   die();
}
</code></pre>
</blockquote>

<p>Use instead:</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">if (Tools::getValue('token') != sha1($this-&gt;module-&gt;name . _COOKIE_KEY_)) {
   echo 'Invalid token!';
   die();
}
</code></pre>
</blockquote>

<p><em>4) If you store a PrestaShop Configuration and compare it to a GET or POST parameter, check previously the configuration and the token submitted value is not empty (isset is not suffisant). In fact, the PrestaShop configuration with the referral token can be empty before module activation (or empty by an sql injection). In this case, the controller is potentially available with an empty token !</em></p>

<blockquote>
  <p><strong><em>DON’T DO:</em></strong></p>
  <pre><code class="language-PHP">if (isset(Tools::getValue('token')) === true ||
       Tools::getValue('token') != Configuration::get('MYMODULE_TOKEN')) {
   echo 'Invalid token!';
   die();
}
</code></pre>
</blockquote>

<p>Use instead:</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">if (empty(Tools::getValue('token')) === true ||
       Tools::getValue('token') != Configuration::get('MYMODULE_TOKEN')) {
   echo 'Invalid token!';
   die();
}
</code></pre>
</blockquote>

<h2 id="callback-of-a-wildcard-method">Callback of a wildcard method</h2>

<p>This is an example that can call any method of the main Module classes like getAdminFullUrl.</p>

<blockquote>
  <p><strong><em>DON’T DO:</em></strong></p>
  <pre><code class="language-PHP">class MyModule extends Module
{
  public function hookDisplayHeader()
  {
       if (Tools::getIsset('ajax') &amp;&amp; Tools::getIsset('method')) {
          $ajax = Tools::getValue('method');
       	if (method_exists($this, $ajax)) {
               $result = $this-&gt;$ajax();
               die(Tools::jsonEncode($result));
       	}
      }
  }
}
</code></pre>
</blockquote>

<p>To prevent any malicious uses, you need to define an exhaustive list of permitted methods to call.</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">class MyModule extends Module
{
  public function hookDisplayHeader()
  {
       if (Tools::getIsset('ajax') &amp;&amp; Tools::getIsset('method')) {
       	$ajax = Tools::getValue('method');
       	if (method_exists($this, $ajax) &amp;&amp; in_array($ajax, ['ajaxPrice','ajaxLink',])) {
              $result = $this-&gt;$ajax();
              die(Tools::jsonEncode($result));
       	}
      }
  }
}
</code></pre>
</blockquote>

<h2 id="wildcard-data-in-the-prestashop-secures-cookie">Wildcard data in the PrestaShop secures cookie</h2>

<p>This code saves in the PrestaShop secured cookie a new variable.</p>

<blockquote>
  <p><strong><em>DON’T DO:</em></strong></p>
  <pre><code class="language-PHP">class TestModuleFrontController extends ModuleFrontController
{
   public function displayAjaxFavoriteOrder() {
       $name = Tools::getValue('name');
       $this-&gt;context-&gt;cookie-&gt;$name = Tools::getValue('value');
       $this-&gt;context-&gt;cookie-&gt;write();
   }
}
</code></pre>
</blockquote>

<p>But it can also be used to update other data of the cookie like the sessions.</p>

<blockquote>
  <p><strong><em>DO:</em></strong></p>
  <pre><code class="language-PHP">class TestModuleFrontController extends ModuleFrontController
{
   public function displayAjaxFavoriteOrder() {
       $name = Tools::getValue('name');
       if (in_array($name, ['product', 'category',]) === false) {
          exit;
       }
       $this-&gt;context-&gt;cookie-&gt;$name = Tools::getValue('value');
       $this-&gt;context-&gt;cookie-&gt;write();
   }
}
</code></pre>
</blockquote>

<p><br /></p>

<hr />

<p><br /></p>

<table>
  <tbody>
    <tr>
      <td><a href="/security-advisories/kb/cross_script_vulnerability.html"><img src="/kb/images/left-arrow-9133251.png" alt="go left" /></a></td>
      <td><a href="/kb/cross_script_vulnerability.html">Prevent Cross Script (XSS) vulnerability</a></td>
      <td><a href="/security-advisories/kb/index.html"><img src="/kb/images/back-to-menu-arrow-9121722.png" alt="go back" /></a></td>
      <td><a href="#prevent-logical-weakness"><img src="/kb/images/up-arrow-1767592-1502496.png" alt="go up" /></a></td>
      <td><a href="/kb/chain_of_vulnerability.html">Prevent chain of vulnerability</a></td>
      <td><a href="/security-advisories/kb/chain_of_vulnerability.html"><img src="/kb/images/right-arrow.png" alt="go right" /></a></td>
    </tr>
  </tbody>
</table>


      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/cbourgeois202/security-advisories">security-advisories</a> is maintained by <a href="https://github.com/cbourgeois202">cbourgeois202</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>
  </body>
</html>
